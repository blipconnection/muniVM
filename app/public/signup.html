<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="css/login.css">
  <link rel="manifest" href="manifest.json">
  <!-- iOS support -->
  <link rel="apple-touch-icon" href="images/icons/icon-72x72.png">
  <link rel="apple-touch-icon" href="images/icons/icon-96x96.png">
  <link rel="apple-touch-icon" href="images/icons/icon-128x128.png">
  <link rel="apple-touch-icon" href="images/icons/icon-144x144.png">
  <link rel="apple-touch-icon" href="images/icons/icon-152x152.png">
  <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="images/icons/icon-384x384.png">
  <link rel="apple-touch-icon" href="images/icons/icon-512x512.png">
  <meta name="apple-mobile-web-app-status-bar" content="#db4938">
  <meta name="theme-color" content="#db4938">
  <meta name="description" content="Credencial digital de estudiante">
  <title>Credencial Digital UPC</title>
  <script type="module">
    import { handleSignupForm } from "./js/auth.js";
    import { alreadyAuthenticated } from "./middleware/notAuthenticated.js";
    // Verificar si el usuario ya est치 autenticado
    alreadyAuthenticated();
    // Manejar el formulario de registro
    handleSignupForm();
  </script>
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <img src="images/logoupc.png" alt="UPC Logo" class="logo">
    </div>
    <form class="login-form" id="signupForm">
      <!-- Paso 1 -->
      <div class="form-step active" id="step-1">
        <input type="text" id="name" placeholder="Nombre" required>
        <div class="error-message" id="nameError"></div>

        <input type="text" id="lastname" placeholder="Apellido" required>
        <div class="error-message" id="lastnameError"></div>

        <div class="input-group">
          <select id="idType">
            <option value="cuil">CUIL</option>
            <option value="passport">Pasaporte</option>
          </select>
          <input type="text" id="cuil-passport" placeholder="CUIL" required>
          <select id="country" required style="display: none;"></select>
        </div>
        <div class="error-message" id="countryError"></div>
        <div class="error-message" id="idError"></div>

        <label for="birthdate">Fecha de Nacimiento:</label>
        <div class="birthdate-container">
          <select id="day" required></select>
          <select id="month" required></select>
          <select id="year" required></select>
        </div>
        <div class="error-message" id="ageError">Debes tener al menos 18 a침os para registrarte</div>

        <button type="button" class="login-button" id="next-1">Siguiente</button>
      </div>

      <!-- Paso 2 -->
      <div class="form-step" id="step-2">
        <h3>Formaci칩n Acad칠mica</h3>
        <select id="facultad" required></select>
        <select id="carrera" required></select>
        <input type="number" id="yearIngreso" placeholder="A침o de Ingreso" required>
        <button type="button" class="login-button" id="prev-1">Anterior</button>
        <button type="button" class="login-button" id="next-2">Siguiente</button>
      </div>

      <!-- Paso 3 -->
      <div class="form-step" id="step-3">
        <h3>Credenciales de Acceso</h3>
        <input type="email" id="email" placeholder="Correo electr칩nico" required>
        <div class="error-message" id="emailError">Por favor ingrese un correo institucional (@upc.edu.ar)</div>

        <div class="password-container">
          <input type="password" id="password" placeholder="Contrase침a" required>
          <button type="button" class="show-password" data-target="password">游녜</button>
        </div>
        <div class="password-container">
          <input type="password" id="confirm-password" placeholder="Confirmar contrase침a" required>
          <button type="button" class="show-password" data-target="confirm-password">游녜</button>
        </div>
        <div class="error-message" id="passwordError"></div>

        <button type="button" class="login-button" id="prev-2">Anterior</button>
        <button type="submit" class="login-button">Registrarte</button>
      </div>

      <div class="forgot-password">
        <a href="/login">쯏a tienes cuenta?</a>
      </div>
    </form>

    <div id="successMessage" class="success-message" style="display: none;">
      <h3>Registro exitoso</h3>
      <p>Por favor, verifica el enlace de activaci칩n enviado a tu correo electr칩nico.</p>
    </div>
  </div>

  <div id="notification-container" class="notification-container"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /* ===========================
         Funciones de Utilidad
      =========================== */
      const showError = (input, errorId, message) => {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.style.display = "block";
        }
        if (input) input.style.borderColor = "red";
      };

      const hideError = (input, errorId) => {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
          errorEl.style.display = "none";
        }
        if (input) input.style.borderColor = "#F5A623";
      };

      const validateField = (input, isValid, errorId, message) => {
        isValid ? hideError(input, errorId) : showError(input, errorId, message);
      };

      const populateSelect = (selectEl, start, end, defaultVal, formatter = v => v) => {
        for (let i = start; i <= end; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = formatter(i);
          if (i === defaultVal) option.selected = true;
          selectEl.appendChild(option);
        }
      };

      const populateOptions = (selectEl, options, defaultText) => {
        selectEl.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = defaultText;
        defaultOption.disabled = true;
        defaultOption.selected = true;
        selectEl.appendChild(defaultOption);
        options.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          selectEl.appendChild(option);
        });
      };

      /* ===========================
         Manejo de Pasos del Formulario
      =========================== */
      const steps = document.querySelectorAll(".form-step");
      let currentStep = 0;
      const showStep = (index) => {
        steps.forEach((step, i) => step.classList.toggle("active", i === index));
        currentStep = index;
      };

      const validateStep = (index) => {
        let isValid = true;
        const inputs = steps[index].querySelectorAll("input, select, textarea");

        inputs.forEach(input => {
          const errorId = input.id + "Error";
          hideError(input, errorId); // Oculta errores previos
          // Se ocultan errores previos (si existen)
          if (document.getElementById(errorId)) hideError(input, errorId);
          if (!input.value.trim()) {
            isValid = false;
            showError(input, errorId, "Este campo es obligatorio.");
          }
        });

        // Validaciones adicionales para el paso 1 (datos personales)
        if (index === 0) {
          const day = document.getElementById("day").value;
          const month = document.getElementById("month").value;
          const year = document.getElementById("year").value;
          if (day && month && year) {
            const birthdate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
              age--;
            }
            if (age < 18) {
              isValid = false;
              showError(null, "ageError", "Debes tener al menos 18 a침os para registrarte.");
            } else {
              hideError(null, "ageError");
            }
          }
          // Validar selecci칩n de pa칤s si se ha elegido "Pasaporte"
          if (document.getElementById("idType").value === "passport") {
            const countrySelect = document.getElementById("country");
            if (!countrySelect.value) {
              isValid = false;
              showError(null, "countryError", "Debes seleccionar tu nacionalidad.");
            } else {
              hideError(null, "countryError");
            }
          }

          // Validar el nombre: solo letras y espacios
          const nameInput = document.getElementById("name");
          const namePattern = /^[A-Za-z츼칄칈칍칔치칠칤칩칰칌침\s]+$/;
          if (nameInput.value && !namePattern.test(nameInput.value)) {
            isValid = false;
            showError(nameInput, "nameError", "El nombre solo puede contener letras y espacios.");
          } else {
            hideError(nameInput, "nameError");
          }

          // Validar el apellido: solo letras y espacios
          const lastnameInput = document.getElementById("lastname");
          if (lastnameInput.value && !namePattern.test(lastnameInput.value)) {
            isValid = false;
            showError(lastnameInput, "lastnameError", "El apellido solo puede contener letras y espacios.");
          } else {
            hideError(lastnameInput, "lastnameError");
          }

          // Validar CUIL o Pasaporte seg칰n corresponda
          const idInput = document.getElementById("cuil-passport");
          const idTypeValue = document.getElementById("idType").value;
          if (idInput.value) {
            if (idTypeValue === "cuil") {
              const cuilPattern = /^\d{11}$/;
              if (!cuilPattern.test(idInput.value)) {
                isValid = false;
                showError(idInput, "idError", "El CUIL debe contener exactamente 11 n칰meros.");
              } else {
                hideError(idInput, "idError");
              }
            } else if (idTypeValue === "passport") {
              const passportPattern = /^[A-Za-z0-9]+$/;
              if (!passportPattern.test(idInput.value)) {
                isValid = false;
                showError(idInput, "idError", "El pasaporte solo puede contener letras y n칰meros.");
              } else {
                hideError(idInput, "idError");
              }
            }
          }
        }
        return isValid;
      };

      /* ===========================
         Poblaci칩n de Selects (Fecha y Opciones)
      =========================== */
      const today = new Date();
      const daySelect = document.getElementById("day");
      const monthSelect = document.getElementById("month");
      const yearSelect = document.getElementById("year");

      populateSelect(daySelect, 1, 31, today.getDate());
      const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      months.forEach((m, idx) => {
        const option = document.createElement("option");
        option.value = idx + 1;
        option.textContent = m;
        if (idx + 1 === today.getMonth() + 1) option.selected = true;
        monthSelect.appendChild(option);
      });
      populateSelect(yearSelect, today.getFullYear() - 100, today.getFullYear(), today.getFullYear());

      // Facultades y carreras
      const facultades = {
        "FAD": ["Licenciatura en Composici칩n Coreogr치fica", "Licenciatura en Interpretaci칩n Musical", "Licenciatura en Artes Escenot칠cnicas", "Licenciatura en Artes Mediales", "Licenciatura en Dise침o", "Licenciatura en Fotograf칤a", "Licenciatura en Gesti칩n Cultural", "Licenciatura en M칰sica Popular Argentina", "Profesorado de Artes Visuales", "Profesorado de Danza", "Profesorado de M칰sica", "Profesorado de Teatro", "Tecnicatura en Arte Cer치mico", "Tecnicatura en Arte Textil", "Tecnicatura en Artes del Fuego", "Tecnicatura en Danza Contempor치nea", "Tecnicatura en Dise침o de Indumentaria", "Tecnicatura en Dise침o de Interiores", "Tecnicatura en Dise침o Gr치fico", "Tecnicatura en Ebanister칤a", "Tecnicatura en Encuadernaci칩n y Conservaci칩n de Libros", "Tecnicatura en Gesti칩n del Patrimonio Cultural", "Tecnicatura en Instrumentista Musical", "Tecnicatura en Matricer칤a y Molder칤a Cer치mica", "Tecnicatura en Producci칩n Art칤stico Visual", "Trayecto de Formaci칩n Musical en Instrumento"],
        "FES": ["Licenciatura en Pedagog칤a Social", "Licenciatura en Psicomotricidad", "Licenciatura en Psicopedagog칤a", "Profesorado de Educaci칩n Especial", "Especializaci칩n en Intervenciones Socioeducativas en Infancias Tempranas"],
        "FEF": ["Licenciatura en Educaci칩n F칤sica", "Profesorado de Educaci칩n F칤sica", "Tecnicatura en Actividad F칤sica", "Especializaci칩n en Recreaci칩n y Juego", "Maestr칤a en Educaci칩n F칤sica Escolar", "Maestr칤a en Recreaci칩n y Juego con Perspectiva Latinoamericana"],
        "IGTP": ["Tecnicatura en Ciencia de Datos e Inteligencia Artificial", "Tecnicatura en Desarrollo Sostenible", "Tecnicatura en Desarrollo y Producci칩n de Videojuegos", "Tecnicatura en Marketing y Negocios Digitales", "Tecnicatura en Programaci칩n Full Stack", "Licenciatura en Administraci칩n y Gesti칩n P칰blica", "Licenciatura en Administraci칩n de Empresas", "Licenciatura en Organizaci칩n Industrial", "Especializaci칩n en Gesti칩n P칰blica"],
        "SRBV": ["Profesorado de Biolog칤a", "Profesorado de Educaci칩n Especial", "Profesorado de F칤sica", "Tecnicatura en Desarrollo Sostenible", "Tecnicatura en Desarrollo y Producci칩n de Videojuegos", "Tecnicatura en Marketing y Negocios Digitales", "Licenciatura en Administraci칩n de Empresas", "Profesorado Universitario de Qu칤mica", "Profesorado de Educaci칩n Inicial", "Profesorado de Educaci칩n Secundaria en Econom칤a", "Profesorado de Educaci칩n Secundaria en Geograf칤a", "Profesorado de Educaci칩n Secundaria en Historia", "Profesorado de Educaci칩n Secundaria en Lengua y Literatura"],
        "FTA": ["Licenciatura en Turismo", "Tecnicatura en Gastronom칤a", "Tecnicatura en Gesti칩n de viajes y turismo", "Tecnicatura en Guardaparque", "Tecnicatura en Gu칤a de Turismo", "Tecnicatura en Hoteler칤a"]
      };

      const facultadSelect = document.getElementById("facultad");
      const carreraSelect = document.getElementById("carrera");

      populateOptions(facultadSelect, Object.keys(facultades), "Seleccione una facultad");
      facultadSelect.addEventListener("change", () => {
        populateOptions(carreraSelect, facultades[facultadSelect.value], "Seleccione una carrera");
      });

      /* ===========================
         Validaciones Personalizadas
      =========================== */
      // Validar texto (solo letras y espacios)
      const validateText = text => /^[A-Za-z츼칄칈칍칔치칠칤칩칰칌침\s]+$/.test(text);
      const attachValidation = (inputId, errorId, validationFn, message) => {
        const input = document.getElementById(inputId);
        input.addEventListener("input", () => {
          validateField(input, validationFn(input.value), errorId, message);
        });
      };

      attachValidation("name", "nameError", validateText, "El nombre solo puede contener letras y espacios");
      attachValidation("lastname", "lastnameError", validateText, "El apellido solo puede contener letras y espacios");

      // Validar CUIL/Pasaporte
      const idType = document.getElementById("idType");
      const idInput = document.getElementById("cuil-passport");

      const validateCUIL = cuil => /^\d{11}$/.test(cuil);
      const validatePassport = passport => /^[A-Za-z0-9]+$/.test(passport);

      idInput.addEventListener("input", () => {
        let isValid = false, errorMsg = "";
        if (idType.value === "cuil") {
          isValid = validateCUIL(idInput.value);
          errorMsg = "El CUIL debe contener exactamente 11 n칰meros.";
        } else {
          isValid = validatePassport(idInput.value);
          errorMsg = "El pasaporte solo puede contener letras y n칰meros.";
        }
        validateField(idInput, isValid, "idError", errorMsg);
      });

      /* Manejo del select de pa칤s para pasaporte */
      const countrySelect = document.getElementById("country");
      const countries = [
        "Argentina", "Brasil", "Chile", "Colombia", "Espa침a", "M칠xico", "Per칰",
        "Estados Unidos", "Francia", "Alemania", "Italia", "Reino Unido", "Canad치"
      ];

      const populateCountrySelect = (isPassport) => {
        // Clonamos la lista original para no modificarla permanentemente
        let countryList = [...countries];

        // Si es pasaporte, removemos "Argentina" de la lista
        if (isPassport) {
          countryList = countryList.filter(c => c !== "Argentina");
        }

        // Ahora llamamos a populateOptions con la lista filtrada
        populateOptions(countrySelect, countryList, "Pa칤s");

        // Si NO es pasaporte, ponemos Argentina como valor por defecto
        if (!isPassport) {
          countrySelect.value = "Argentina";
        }
      };
      populateCountrySelect();

      idType.addEventListener("change", () => {
        idInput.value = "";
        idInput.placeholder = (idType.value === "cuil") ? "CUIL" : "Pasaporte";

        if (idType.value === "passport") {
          countrySelect.style.display = "block";
          // Llamamos a la funci칩n indicando que es pasaporte
          populateCountrySelect(true);
          // Dejamos el select en "Pa칤s" (vac칤o) para forzar al usuario a elegir uno
          countrySelect.value = "";
        } else {
          countrySelect.style.display = "none";
          // Llamamos a la funci칩n indicando que NO es pasaporte
          populateCountrySelect(false);
        }
      });

      // Validar correo institucional (@upc.edu.ar)
      const emailField = document.getElementById("email");
      emailField.addEventListener("blur", () => {
        const emailPattern = /^[a-zA-Z0-9._%+-]+@upc\.edu\.ar$/;
        validateField(emailField, emailPattern.test(emailField.value), "emailError",
                      "Por favor ingrese un correo institucional (@upc.edu.ar)");
      });

      // Validar que las contrase침as coincidan
      const password = document.getElementById("password");
      const confirmPassword = document.getElementById("confirm-password");
      confirmPassword.addEventListener("input", () => {
        validateField(confirmPassword, password.value === confirmPassword.value,
                      "passwordError", "Las contrase침as no coinciden");
      });

      /* ===========================
         Mostrar/Ocultar Contrase침as
      =========================== */
      const togglePassword = (fieldId, show) => {
        const field = document.getElementById(fieldId);
        field.type = show ? "text" : "password";
      };

      document.querySelectorAll(".show-password").forEach(btn => {
        btn.addEventListener("mousedown", () => togglePassword(btn.dataset.target, true));
        btn.addEventListener("mouseup", () => togglePassword(btn.dataset.target, false));
        btn.addEventListener("mouseleave", () => togglePassword(btn.dataset.target, false));
      });

      /* ===========================
         Navegaci칩n entre Pasos
      =========================== */
      document.getElementById("next-1").addEventListener("click", () => {
        if (validateStep(0)) showStep(1);
      });
      document.getElementById("prev-1").addEventListener("click", () => showStep(0));
      document.getElementById("next-2").addEventListener("click", () => {
        if (validateStep(1)) showStep(2);
      });
      document.getElementById("prev-2").addEventListener("click", () => showStep(1));
    });
  </script>
</body>
</html>
